-- Groups Schema updates 7/26/2012

-- rename old groups tables to not conflict with the new schema names
ALTER TABLE kmdata.groups RENAME TO groups_legacy;
ALTER TABLE kmdata.group_categories RENAME TO group_categories_legacy;

-- create new groups schema objects into KMData core


CREATE SEQUENCE kmdata.groups_new_id_seq;

CREATE TABLE kmdata.groups (
                id BIGINT NOT NULL DEFAULT nextval('kmdata.groups_new_id_seq'),
                name VARCHAR(255) NOT NULL,
                description TEXT,
                private BOOLEAN,
                CONSTRAINT groups_new_pk PRIMARY KEY (id)
);


ALTER SEQUENCE kmdata.groups_new_id_seq OWNED BY kmdata.groups.id;


CREATE SEQUENCE kmdata.group_nestings_id_seq;

CREATE TABLE kmdata.group_nestings (
                id BIGINT NOT NULL DEFAULT nextval('kmdata.group_nestings_id_seq'),
                parent_group_id BIGINT NOT NULL,
                child_group_id BIGINT NOT NULL,
                CONSTRAINT group_nestings_pk PRIMARY KEY (id)
);


ALTER SEQUENCE kmdata.group_nestings_id_seq OWNED BY kmdata.group_nestings.id;

ALTER TABLE kmdata.group_nestings ADD CONSTRAINT groups_group_nestings_fk
FOREIGN KEY (parent_group_id)
REFERENCES kmdata.groups (id)
ON DELETE NO ACTION
ON UPDATE NO ACTION
NOT DEFERRABLE;

ALTER TABLE kmdata.group_nestings ADD CONSTRAINT groups_group_nestings_fk1
FOREIGN KEY (child_group_id)
REFERENCES kmdata.groups (id)
ON DELETE NO ACTION
ON UPDATE NO ACTION
NOT DEFERRABLE;

CREATE SEQUENCE kmdata.group_categories_new_id_seq;

CREATE TABLE kmdata.group_categories (
                id BIGINT NOT NULL DEFAULT nextval('kmdata.group_categories_new_id_seq'),
                name VARCHAR(255) NOT NULL,
                CONSTRAINT group_categories_new_pk PRIMARY KEY (id)
);


ALTER SEQUENCE kmdata.group_categories_new_id_seq OWNED BY kmdata.group_categories.id;

CREATE SEQUENCE kmdata.group_categorizations_id_seq;

CREATE TABLE kmdata.group_categorizations (
                id BIGINT NOT NULL DEFAULT nextval('kmdata.group_categorizations_id_seq'),
                group_id BIGINT NOT NULL,
                category_id BIGINT NOT NULL,
                CONSTRAINT group_categorizations_pk PRIMARY KEY (id)
);


ALTER SEQUENCE kmdata.group_categorizations_id_seq OWNED BY kmdata.group_categorizations.id;

ALTER TABLE kmdata.group_categorizations ADD CONSTRAINT group_categories_group_categorizations_fk
FOREIGN KEY (category_id)
REFERENCES kmdata.group_categories (id)
ON DELETE NO ACTION
ON UPDATE NO ACTION
NOT DEFERRABLE;

ALTER TABLE kmdata.group_categorizations ADD CONSTRAINT groups_group_categorizations_fk
FOREIGN KEY (group_id)
REFERENCES kmdata.groups (id)
ON DELETE NO ACTION
ON UPDATE NO ACTION
NOT DEFERRABLE;

CREATE SEQUENCE kmdata.group_properties_id_seq;

CREATE TABLE kmdata.group_properties (
                id BIGINT NOT NULL DEFAULT nextval('kmdata.group_properties_id_seq'),
                name VARCHAR(255) NOT NULL,
                description TEXT,
                datatype VARCHAR(30) NOT NULL,
                CONSTRAINT group_properties_pk PRIMARY KEY (id)
);


ALTER SEQUENCE kmdata.group_properties_id_seq OWNED BY kmdata.group_properties.id;

CREATE SEQUENCE kmdata.group_property_values_id_seq;

CREATE TABLE kmdata.group_property_values (
                id BIGINT NOT NULL DEFAULT nextval('kmdata.group_property_values_id_seq'),
                group_id BIGINT NOT NULL,
                group_property_id BIGINT NOT NULL,
                boolean_value BOOLEAN,
                string_value VARCHAR(4000),
                integer_value BIGINT,
                CONSTRAINT group_property_values_pk PRIMARY KEY (id)
);


ALTER SEQUENCE kmdata.group_property_values_id_seq OWNED BY kmdata.group_property_values.id;

ALTER TABLE kmdata.group_property_values ADD CONSTRAINT group_properties_group_property_values_fk
FOREIGN KEY (group_property_id)
REFERENCES kmdata.group_properties (id)
ON DELETE NO ACTION
ON UPDATE NO ACTION
NOT DEFERRABLE;

ALTER TABLE kmdata.group_property_values ADD CONSTRAINT groups_group_property_values_fk
FOREIGN KEY (group_id)
REFERENCES kmdata.groups (id)
ON DELETE NO ACTION
ON UPDATE NO ACTION
NOT DEFERRABLE;

CREATE SEQUENCE kmdata.group_permissions_id_seq;

CREATE TABLE kmdata.group_permissions (
                id BIGINT NOT NULL DEFAULT nextval('kmdata.group_permissions_id_seq'),
                group_id BIGINT NOT NULL,
                permission_set INTEGER,
                managing_group_id BIGINT NOT NULL,
                CONSTRAINT group_permissions_pk PRIMARY KEY (id)
);


ALTER SEQUENCE kmdata.group_permissions_id_seq OWNED BY kmdata.group_permissions.id;

ALTER TABLE kmdata.group_permissions ADD CONSTRAINT groups_group_permissions_fk
FOREIGN KEY (group_id)
REFERENCES kmdata.groups (id)
ON DELETE NO ACTION
ON UPDATE NO ACTION
NOT DEFERRABLE;

ALTER TABLE kmdata.group_permissions ADD CONSTRAINT groups_group_permissions_fk1
FOREIGN KEY (managing_group_id)
REFERENCES kmdata.groups (id)
ON DELETE NO ACTION
ON UPDATE NO ACTION
NOT DEFERRABLE;

CREATE SEQUENCE kmdata.group_memberships_id_seq;

CREATE TABLE kmdata.group_memberships (
                id BIGINT NOT NULL DEFAULT nextval('kmdata.group_memberships_id_seq'),
                resource_id BIGINT NOT NULL,
                group_id BIGINT NOT NULL,
                CONSTRAINT group_memberships_pk PRIMARY KEY (id)
);


ALTER SEQUENCE kmdata.group_memberships_id_seq OWNED BY kmdata.group_memberships.id;

ALTER TABLE kmdata.group_memberships ADD CONSTRAINT groups_group_memberships_fk
FOREIGN KEY (group_id)
REFERENCES kmdata.groups (id)
ON DELETE NO ACTION
ON UPDATE NO ACTION
NOT DEFERRABLE;

ALTER TABLE kmdata.group_memberships ADD CONSTRAINT resources_group_memberships_fk
FOREIGN KEY (resource_id)
REFERENCES kmdata.resources (id)
ON DELETE NO ACTION
ON UPDATE NO ACTION
NOT DEFERRABLE;

CREATE SEQUENCE kmdata.group_exclusions_id_seq;

CREATE TABLE kmdata.group_exclusions (
                id BIGINT NOT NULL DEFAULT nextval('kmdata.group_exclusions_id_seq'),
                group_id BIGINT NOT NULL,
                resource_id BIGINT NOT NULL,
                CONSTRAINT group_exclusions_pk PRIMARY KEY (id)
);


ALTER SEQUENCE kmdata.group_exclusions_id_seq OWNED BY kmdata.group_exclusions.id;

ALTER TABLE kmdata.group_exclusions ADD CONSTRAINT groups_group_exclusions_fk
FOREIGN KEY (group_id)
REFERENCES kmdata.groups (id)
ON DELETE NO ACTION
ON UPDATE NO ACTION
NOT DEFERRABLE;

ALTER TABLE kmdata.group_exclusions ADD CONSTRAINT resources_group_exclusions_fk
FOREIGN KEY (resource_id)
REFERENCES kmdata.resources (id)
ON DELETE NO ACTION
ON UPDATE NO ACTION
NOT DEFERRABLE;


-- grant update permissions to Rails application user
GRANT SELECT, UPDATE, INSERT, DELETE ON kmdata.groups TO kmd_ror_app_user;
GRANT USAGE, SELECT, UPDATE ON SEQUENCE kmdata.groups_new_id_seq TO kmd_ror_app_user;
GRANT SELECT, UPDATE, INSERT, DELETE ON kmdata.group_nestings TO kmd_ror_app_user;
GRANT USAGE, SELECT, UPDATE ON SEQUENCE kmdata.group_nestings_id_seq TO kmd_ror_app_user;
GRANT SELECT, UPDATE, INSERT, DELETE ON kmdata.group_categories TO kmd_ror_app_user;
GRANT USAGE, SELECT, UPDATE ON SEQUENCE kmdata.group_categories_new_id_seq TO kmd_ror_app_user;
GRANT SELECT, UPDATE, INSERT, DELETE ON kmdata.group_categorizations TO kmd_ror_app_user;
GRANT USAGE, SELECT, UPDATE ON SEQUENCE kmdata.group_categorizations_id_seq TO kmd_ror_app_user;
GRANT SELECT, UPDATE, INSERT, DELETE ON kmdata.group_properties TO kmd_ror_app_user;
GRANT USAGE, SELECT, UPDATE ON SEQUENCE kmdata.group_properties_id_seq TO kmd_ror_app_user;
GRANT SELECT, UPDATE, INSERT, DELETE ON kmdata.group_property_values TO kmd_ror_app_user;
GRANT USAGE, SELECT, UPDATE ON SEQUENCE kmdata.group_property_values_id_seq TO kmd_ror_app_user;
GRANT SELECT, UPDATE, INSERT, DELETE ON kmdata.group_permissions TO kmd_ror_app_user;
GRANT USAGE, SELECT, UPDATE ON SEQUENCE kmdata.group_permissions_id_seq TO kmd_ror_app_user;
GRANT SELECT, UPDATE, INSERT, DELETE ON kmdata.group_memberships TO kmd_ror_app_user;
GRANT USAGE, SELECT, UPDATE ON SEQUENCE kmdata.group_memberships_id_seq TO kmd_ror_app_user;
GRANT SELECT, UPDATE, INSERT, DELETE ON kmdata.group_exclusions TO kmd_ror_app_user;
GRANT USAGE, SELECT, UPDATE ON SEQUENCE kmdata.group_exclusions_id_seq TO kmd_ror_app_user;

