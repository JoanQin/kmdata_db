WITH DepartmentsBeforeToday (SETID, DEPTID, EFFDT)
AS
(
	SELECT
		SETID,
		DEPTID,
		EFFDT
	FROM
		ps_new.PS_DEPT_TBL
	WHERE
		EFF_STATUS = 'A'	AND
		SETID = 'OSUSI'		AND
		EFFDT <= GETDATE()
),
MaxDepartmentBeforeToday (SETID, DEPTID, EFFDT)
AS
(
	SELECT 
		SETID,
		DEPTID,
		MAX(EFFDT) AS EFFDT
	FROM
		DepartmentsBeforeToday
	GROUP BY
		SETID, DEPTID
)
SELECT
	  DEPT.SETID
	, DEPT.DEPTID
	, DEPT.EFFDT
	, DEPT.DESCR
	, DEPT.LOCATION
	, DEPT.MANAGER_ID
	, DEPT.BUDGET_DEPTID
	, DEPT.EFF_STATUS
	, DEPT.DESCRSHORT
FROM 
	MaxDepartmentBeforeToday MXDPT
		INNER JOIN ps_new.PS_DEPT_TBL DEPT	ON MXDPT.SETID = DEPT.SETID
											AND MXDPT.DEPTID = DEPT.DEPTID
											AND MXDPT.EFFDT = DEPT.EFFDT












SELECT
  SETID
, DEPTID
, EFFDT
, DESCR
, LOCATION
, MANAGER_ID
, BUDGET_DEPTID
, EFF_STATUS
, DESCRSHORT
FROM ps_new.PS_DEPT_TBL
